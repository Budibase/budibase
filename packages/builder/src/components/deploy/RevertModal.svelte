<script>
  import { Input, Modal, notifications, ModalContent } from "@budibase/bbui"
  import { appStore, initialise } from "@/stores/builder"
  import { featureFlags } from "@/stores/portal"
  import { API } from "@/api"

  export let onComplete = () => {}

  let revertModal
  let appName

  $: appId = $appStore.appId
  $: appOrWorkspace = $featureFlags.WORKSPACE_APPS ? "workspace" : "app"

  const revert = async () => {
    try {
      await API.revertAppChanges(appId)

      // Reset frontend state after revert
      const applicationPkg = await API.fetchAppPackage(appId)
      await initialise(applicationPkg)
      notifications.info("Changes reverted successfully")
      onComplete()
    } catch (error) {
      notifications.error(`Error reverting changes: ${error.message}`)
    }
  }

  export const hide = () => {
    revertModal.hide()
  }

  export const show = () => {
    revertModal.show()
  }
</script>

<Modal bind:this={revertModal}>
  <ModalContent
    title="Revert changes"
    confirmText="Revert"
    onConfirm={revert}
    disabled={appName !== $appStore.name}
  >
    <span>
      The changes you have made will be deleted and the {appOrWorkspace} reverted
      back to its production state.
    </span>
    <span>Please enter your {appOrWorkspace} name to continue.</span>
    <Input bind:value={appName} />
  </ModalContent>
</Modal>
