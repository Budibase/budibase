<script>
  import { ModalContent, Layout, notifications, Body } from "@budibase/bbui"
  import { datasources as datasourcesStore } from "stores/builder"
  import ICONS from "components/backend/DatasourceNavigator/icons"
  import { IntegrationNames } from "constants"
  import { createEventDispatcher, onMount } from "svelte"
  import TableOrViewOption from "./TableOrViewOption.svelte"

  export let onConfirm
  export let selectedTablesAndViews
  export let permissions

  const dispatch = createEventDispatcher()

  const getViews = table => {
    const views = Object.values(table.views || {}).filter(
      view => view.version === 2
    )

    return views.map(view => ({
      icon: "Remove",
      name: view.name,
      id: view.id,
      clientData: {
        ...view,
        type: "viewV2",
        label: view.name,
      },
    }))
  }

  const getTablesAndViews = datasource => {
    let tablesAndViews = []
    const rawTables = Array.isArray(datasource.entities)
      ? datasource.entities
      : Object.values(datasource.entities ?? {})

    for (const rawTable of rawTables) {
      if (rawTable._id === "ta_users") {
        continue
      }

      const table = {
        icon: "Table",
        name: rawTable.name,
        id: rawTable._id,
        clientData: {
          ...rawTable,
          label: rawTable.name,
          tableId: rawTable._id,
          type: "table",
        },
      }

      tablesAndViews = tablesAndViews.concat([table, ...getViews(rawTable)])
    }

    return tablesAndViews
  }

  const getDatasources = rawDatasources => {
    const datasources = []

    for (const rawDatasource of rawDatasources) {
      if (
        rawDatasource.source === IntegrationNames.REST ||
        !rawDatasource["entities"]
      ) {
        continue
      }

      const datasource = {
        name: rawDatasource.name,
        iconComponent: ICONS[rawDatasource.source],
        tablesAndViews: getTablesAndViews(rawDatasource),
      }

      datasources.push(datasource)
    }

    return datasources
  }

  $: datasources = getDatasources($datasourcesStore.list)

  const toggleSelection = tableOrView => {
    dispatch("toggle", tableOrView)
  }

  onMount(async () => {
    try {
      await datasourcesStore.fetch()
    } catch (error) {
      notifications.error("Error fetching datasources")
    }
  })
</script>

<span>
  <ModalContent
    title="Autogenerated screens"
    confirmText="Confirm"
    cancelText="Back"
    {onConfirm}
    disabled={!selectedTablesAndViews.length}
    size="L"
  >
    <Body size="S">
      Select which datasources you would like to use to create your screens
    </Body>
    <Layout noPadding gap="S">
      {#each datasources as datasource}
        <div class="data-source-wrap">
          <div class="data-source-header">
            <svelte:component
              this={datasource.iconComponent}
              height="24"
              width="24"
            />
            <div class="data-source-name">{datasource.name}</div>
          </div>
          <!-- List all tables -->
          {#each datasource.tablesAndViews as tableOrView}
            {@const selected = selectedTablesAndViews.some(
              selected => selected.id === tableOrView.id
            )}
            <TableOrViewOption
              roles={permissions[tableOrView.id]}
              on:click={() => toggleSelection(tableOrView)}
              {selected}
              {tableOrView}
            />
          {/each}
        </div>
      {/each}
    </Layout>
  </ModalContent>
</span>

<style>
  .data-source-wrap {
    padding-bottom: var(--spectrum-alias-item-padding-s);
    display: flex;
    flex-direction: column;
    grid-gap: var(--spacing-s);
    max-width: 100%;
    min-width: 0;
  }
  .data-source-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-m);
    padding-bottom: var(--spacing-xs);
  }
</style>
