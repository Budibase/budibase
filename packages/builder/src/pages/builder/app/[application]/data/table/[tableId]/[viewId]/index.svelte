<script lang="ts">
  import {
    viewsV2,
    rowActions,
    dataEnvironmentStore,
    tables,
    datasources,
    dataAPI,
  } from "@/stores/builder"
  import { admin, themeStore, licensing } from "@/stores/portal"
  import { Grid } from "@budibase/frontend-core"
  import { notifications } from "@budibase/bbui"
  import GridCreateEditRowModal from "@/components/backend/DataTable/modals/grid/GridCreateEditRowModal.svelte"
  import GridFilterButton from "@/components/backend/DataTable/buttons/grid/GridFilterButton.svelte"
  import GridManageAccessButton from "@/components/backend/DataTable/buttons/grid/GridManageAccessButton.svelte"
  import GridSortButton from "@/components/backend/DataTable/buttons/grid/GridSortButton.svelte"
  import GridColumnsSettingButton from "@/components/backend/DataTable/buttons/grid/GridColumnsSettingButton.svelte"
  import GridSizeButton from "@/components/backend/DataTable/buttons/grid/GridSizeButton.svelte"
  import GridGenerateButton from "@/components/backend/DataTable/buttons/grid/GridGenerateButton.svelte"
  import GridScreensButton from "@/components/backend/DataTable/buttons/grid/GridScreensButton.svelte"
  import GridRowActionsButton from "@/components/backend/DataTable/buttons/grid/GridRowActionsButton.svelte"
  import GridViewCalculationButton from "@/components/backend/DataTable/buttons/grid/GridViewCalculationButton.svelte"
  import GridDevProdSwitcher from "@/components/backend/DataTable/buttons/grid/GridDevProdSwitcher.svelte"
  import { ViewV2Type, DataEnvironmentMode, type Row } from "@budibase/types"
  import { DB_TYPE_EXTERNAL } from "@/constants/backend"

  let generateButton: any

  $: view = $viewsV2.selected
  $: calculation = view?.type === ViewV2Type.CALCULATION
  $: id = view?.id!
  $: datasource = {
    type: "viewV2",
    id,
    tableId: view?.tableId,
  }
  $: buttons = makeRowActionButtons($rowActions[id])
  $: rowActions.refreshRowActions(id)
  $: currentTheme = $themeStore?.theme
  $: darkMode = !currentTheme.includes("light")
  $: isProductionMode =
    $dataEnvironmentStore.mode === DataEnvironmentMode.PRODUCTION
  $: underlyingTable = view?.tableId
    ? $tables.list.find(t => t._id === view.tableId)
    : null
  $: isInternal = underlyingTable?.sourceType !== DB_TYPE_EXTERNAL
  $: tableDatasource = underlyingTable
    ? $datasources.list.find(datasource => {
        return datasource._id === underlyingTable.sourceId
      })
    : null
  $: showDevProdSwitcher = !(
    !isInternal &&
    tableDatasource &&
    !tableDatasource.usesEnvironmentVariables
  )

  const makeRowActionButtons = (actions: any[]) => {
    return (actions || []).map(action => ({
      text: action.name,
      onClick: async (row: Row) => {
        await rowActions.trigger(id, action.id, row._id!)
        notifications.success("Row action triggered successfully")
      },
    }))
  }

  const handleGridViewUpdate = async (e: any) => {
    viewsV2.replaceView(id, e.detail)
  }
</script>

{#key $dataEnvironmentStore.mode}
  <Grid
    API={$dataAPI}
    {darkMode}
    {datasource}
    {buttons}
    allowAddRows
    allowDeleteRows
    aiEnabled={$licensing.customAIConfigsEnabled ||
      $licensing.budibaseAIEnabled}
    showAvatars={false}
    on:updatedatasource={handleGridViewUpdate}
    isCloud={$admin.cloud}
    buttonsCollapsed
  >
    <svelte:fragment slot="controls">
      {#if !isProductionMode}
        <GridManageAccessButton />
        {#if calculation}
          <GridViewCalculationButton />
        {/if}
        <GridFilterButton />
        <GridSortButton />
        <GridSizeButton />
        {#if !calculation}
          <GridColumnsSettingButton />
          <GridRowActionsButton />
          <GridScreensButton on:generate={() => generateButton?.show()} />
        {/if}
        <GridGenerateButton bind:this={generateButton} />
      {/if}
    </svelte:fragment>
    <svelte:fragment slot="controls-right">
      <GridDevProdSwitcher visible={showDevProdSwitcher} />
    </svelte:fragment>
    <GridCreateEditRowModal />
  </Grid>
{/key}
