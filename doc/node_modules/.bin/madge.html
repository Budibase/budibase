<!DOCTYPE html>
<html>
<head>
  <title>madge</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/madge";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>madge</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>);
<span class="hljs-keyword">const</span> program = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>);
<span class="hljs-keyword">const</span> rc = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rc'</span>)(<span class="hljs-string">'madge'</span>);
<span class="hljs-keyword">const</span> version = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../package.json'</span>).version;
<span class="hljs-keyword">const</span> ora = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ora'</span>);
<span class="hljs-keyword">const</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>);
<span class="hljs-keyword">const</span> startTime = <span class="hljs-built_in">Date</span>.now();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Revert https://github.com/tj/commander.js/pull/1409</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">program.storeOptionsAsProperties();

program
	.version(version)
	.usage(<span class="hljs-string">'[options] &lt;src...&gt;'</span>)
	.option(<span class="hljs-string">'-b, --basedir &lt;path&gt;'</span>, <span class="hljs-string">'base directory for resolving paths'</span>)
	.option(<span class="hljs-string">'-s, --summary'</span>, <span class="hljs-string">'show dependency count summary'</span>)
	.option(<span class="hljs-string">'-c, --circular'</span>, <span class="hljs-string">'show circular dependencies'</span>)
	.option(<span class="hljs-string">'-d, --depends &lt;name&gt;'</span>, <span class="hljs-string">'show module dependents'</span>)
	.option(<span class="hljs-string">'-x, --exclude &lt;regexp&gt;'</span>, <span class="hljs-string">'exclude modules using RegExp'</span>)
	.option(<span class="hljs-string">'-j, --json'</span>, <span class="hljs-string">'output as JSON'</span>)
	.option(<span class="hljs-string">'-i, --image &lt;file&gt;'</span>, <span class="hljs-string">'write graph to file as an image'</span>)
	.option(<span class="hljs-string">'-l, --layout &lt;name&gt;'</span>, <span class="hljs-string">'layout engine to use for graph (dot/neato/fdp/sfdp/twopi/circo)'</span>)
	.option(<span class="hljs-string">'--orphans'</span>, <span class="hljs-string">'show modules that no one is depending on'</span>)
	.option(<span class="hljs-string">'--leaves'</span>, <span class="hljs-string">'show modules that have no dependencies'</span>)
	.option(<span class="hljs-string">'--dot'</span>, <span class="hljs-string">'show graph using the DOT language'</span>)
	.option(<span class="hljs-string">'--extensions &lt;list&gt;'</span>, <span class="hljs-string">'comma separated string of valid file extensions'</span>)
	.option(<span class="hljs-string">'--require-config &lt;file&gt;'</span>, <span class="hljs-string">'path to RequireJS config'</span>)
	.option(<span class="hljs-string">'--webpack-config &lt;file&gt;'</span>, <span class="hljs-string">'path to webpack config'</span>)
	.option(<span class="hljs-string">'--ts-config &lt;file&gt;'</span>, <span class="hljs-string">'path to typescript config'</span>)
	.option(<span class="hljs-string">'--include-npm'</span>, <span class="hljs-string">'include shallow NPM modules'</span>, <span class="hljs-literal">false</span>)
	.option(<span class="hljs-string">'--no-color'</span>, <span class="hljs-string">'disable color in output and image'</span>, <span class="hljs-literal">false</span>)
	.option(<span class="hljs-string">'--no-spinner'</span>, <span class="hljs-string">'disable progress spinner'</span>, <span class="hljs-literal">false</span>)
	.option(<span class="hljs-string">'--stdin'</span>, <span class="hljs-string">'read predefined tree from STDIN'</span>, <span class="hljs-literal">false</span>)
	.option(<span class="hljs-string">'--warning'</span>, <span class="hljs-string">'show warnings about skipped files'</span>, <span class="hljs-literal">false</span>)
	.option(<span class="hljs-string">'--debug'</span>, <span class="hljs-string">'turn on debug output'</span>, <span class="hljs-literal">false</span>)
	.parse(process.argv);

<span class="hljs-keyword">if</span> (!program.args.length &amp;&amp; !program.stdin) {
	<span class="hljs-built_in">console</span>.log(program.helpInformation());
	process.exit(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">if</span> (program.debug) {
	process.env.DEBUG = <span class="hljs-string">'*'</span>;
}

<span class="hljs-keyword">if</span> (!program.color) {
	process.env.DEBUG_COLORS = <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">const</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/log'</span>);
<span class="hljs-keyword">const</span> output = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/output'</span>);
<span class="hljs-keyword">const</span> madge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/api'</span>);

<span class="hljs-keyword">let</span> packageConfig = {};
<span class="hljs-keyword">try</span> {
	packageConfig = <span class="hljs-built_in">require</span>(path.join(process.cwd(), <span class="hljs-string">'package.json'</span>)).madge;
} <span class="hljs-keyword">catch</span> (e) { }
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">Object</span>.assign(rc, packageConfig);

program.options.forEach(<span class="hljs-function">(<span class="hljs-params">opt</span>) =&gt;</span> {
	<span class="hljs-keyword">const</span> name = opt.name();

	<span class="hljs-keyword">if</span> (program[name]) {
		config[name] = program[name];
	}
});

<span class="hljs-keyword">const</span> spinner = ora({
	<span class="hljs-attr">text</span>: <span class="hljs-string">'Finding files'</span>,
	<span class="hljs-attr">color</span>: <span class="hljs-string">'white'</span>,
	<span class="hljs-attr">interval</span>: <span class="hljs-number">100000</span>,
	<span class="hljs-attr">isEnabled</span>: program.spinner
});

<span class="hljs-keyword">let</span> exitCode = <span class="hljs-number">0</span>;

<span class="hljs-keyword">delete</span> config._;
<span class="hljs-keyword">delete</span> config.config;
<span class="hljs-keyword">delete</span> config.configs;

<span class="hljs-keyword">if</span> (rc.config) {
	log(<span class="hljs-string">'using runtime config %s'</span>, rc.config);
}

<span class="hljs-keyword">if</span> (program.basedir) {
	config.baseDir = program.basedir;
}

<span class="hljs-keyword">if</span> (program.exclude) {
	config.excludeRegExp = [program.exclude];
}

<span class="hljs-keyword">if</span> (program.extensions) {
	config.fileExtensions = program.extensions.split(<span class="hljs-string">','</span>).map(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.trim());
}

<span class="hljs-keyword">if</span> (program.requireConfig) {
	config.requireConfig = program.requireConfig;
}

<span class="hljs-keyword">if</span> (program.webpackConfig) {
	config.webpackConfig = program.webpackConfig;
}

<span class="hljs-keyword">if</span> (program.tsConfig) {
	config.tsConfig = program.tsConfig;
}

<span class="hljs-keyword">if</span> (program.includeNpm) {
	config.includeNpm = program.includeNpm;
}

<span class="hljs-keyword">if</span> (!program.color) {
	config.backgroundColor = <span class="hljs-string">'#ffffff'</span>;
	config.nodeColor = <span class="hljs-string">'#000000'</span>;
	config.noDependencyColor = <span class="hljs-string">'#000000'</span>;
	config.cyclicNodeColor = <span class="hljs-string">'#000000'</span>;
	config.edgeColor = <span class="hljs-string">'#757575'</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dependencyFilter</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">let</span> prevFile;

	<span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">dependencyFilePath, traversedFilePath, baseDir</span>) =&gt;</span> {
		<span class="hljs-keyword">if</span> (prevFile !== traversedFilePath) {
			<span class="hljs-keyword">const</span> relPath = path.relative(baseDir, traversedFilePath);
			<span class="hljs-keyword">const</span> dir = path.dirname(relPath) + <span class="hljs-string">'/'</span>;
			<span class="hljs-keyword">const</span> file = path.basename(relPath);

			<span class="hljs-keyword">if</span> (program.spinner) {
				spinner.text = chalk.grey(dir) + chalk.cyan(file);
				spinner.render();
			}
			prevFile = traversedFilePath;
		}
	};
}

<span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
	<span class="hljs-keyword">if</span> (program.stdin) {
		<span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>;

		process.stdin
			.resume()
			.setEncoding(<span class="hljs-string">'utf8'</span>)
			.on(<span class="hljs-string">'data'</span>, (chunk) =&gt; {
				buffer += chunk;
			})
			.on(<span class="hljs-string">'end'</span>, () =&gt; {
				<span class="hljs-keyword">try</span> {
					resolve(<span class="hljs-built_in">JSON</span>.parse(buffer));
				} <span class="hljs-keyword">catch</span> (e) {
					reject(e);
				}
			});
	} <span class="hljs-keyword">else</span> {
		resolve(program.args);
	}
})
	.then(<span class="hljs-function">(<span class="hljs-params">src</span>) =&gt;</span> {
		<span class="hljs-keyword">if</span> (!program.json &amp;&amp; !program.dot) {
			spinner.start();
			config.dependencyFilter = dependencyFilter();
		}

		<span class="hljs-keyword">return</span> madge(src, config);
	})
	.then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
		<span class="hljs-keyword">if</span> (!program.json &amp;&amp; !program.dot) {
			spinner.stop();
			output.getResultSummary(res, startTime);
		}

		<span class="hljs-keyword">const</span> result = createOutputFromOptions(program, res);
		<span class="hljs-keyword">if</span> (result !== <span class="hljs-literal">undefined</span>) {
			<span class="hljs-keyword">return</span> result;
		}

		output.list(res.obj(), {
			<span class="hljs-attr">json</span>: program.json
		});

		<span class="hljs-keyword">return</span> res;
	})
	.then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
		<span class="hljs-keyword">if</span> (program.warning &amp;&amp; !program.json) {
			output.warnings(res);
		}

		<span class="hljs-keyword">if</span> (!program.json &amp;&amp; !program.dot) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">''</span>);
		}

		process.exit(exitCode);
	})
	.catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
		spinner.stop();
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'\n%s %s\n'</span>, chalk.red(<span class="hljs-string">'✖'</span>), err.stack);
		process.exit(<span class="hljs-number">1</span>);
	});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createOutputFromOptions</span>(<span class="hljs-params">program, res</span>) </span>{
	<span class="hljs-keyword">if</span> (program.summary) {
		output.summary(res.obj(), {
			<span class="hljs-attr">json</span>: program.json
		});

		<span class="hljs-keyword">return</span> res;
	}

	<span class="hljs-keyword">if</span> (program.depends) {
		output.modules(res.depends(program.depends), {
			<span class="hljs-attr">json</span>: program.json
		});

		<span class="hljs-keyword">return</span> res;
	}

	<span class="hljs-keyword">if</span> (program.orphans) {
		output.modules(res.orphans(), {
			<span class="hljs-attr">json</span>: program.json
		});

		<span class="hljs-keyword">return</span> res;
	}

	<span class="hljs-keyword">if</span> (program.leaves) {
		output.modules(res.leaves(), {
			<span class="hljs-attr">json</span>: program.json
		});

		<span class="hljs-keyword">return</span> res;
	}

	<span class="hljs-keyword">if</span> (program.image) {
		<span class="hljs-keyword">return</span> res.image(program.image, program.circular).then(<span class="hljs-function">(<span class="hljs-params">imagePath</span>) =&gt;</span> {
			spinner.succeed(<span class="hljs-string">`<span class="hljs-subst">${chalk.bold(<span class="hljs-string">'Image created at'</span>)}</span> <span class="hljs-subst">${chalk.cyan.bold(imagePath)}</span>`</span>);
			<span class="hljs-keyword">return</span> res;
		});
	}

	<span class="hljs-keyword">if</span> (program.dot) {
		<span class="hljs-keyword">return</span> res.dot(program.circular).then(<span class="hljs-function">(<span class="hljs-params">output</span>) =&gt;</span> {
			process.stdout.write(output);
			<span class="hljs-keyword">return</span> res;
		});
	}

	<span class="hljs-keyword">if</span> (program.circular) {
		<span class="hljs-keyword">const</span> circular = res.circular();

		output.circular(spinner, res, circular, {
			<span class="hljs-attr">json</span>: program.json
		});

		<span class="hljs-keyword">if</span> (circular.length) {
			exitCode = <span class="hljs-number">1</span>;
		}

		<span class="hljs-keyword">return</span> res;
	}
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
